<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–≠–º–∏–ª–∏—è –∏ –∫–∞–º—É—à–∫–∏ –≤ –≤–æ–ª–æ—Å–∞—Ö ‚Äî v2025-10-07.12</title>

<link rel="stylesheet" href="css/dflip.min.css" />

<style>
body{
  margin:0;background:#e9ecef;min-height:100vh;
  display:grid;place-items:center;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif
}
.frame{
  width:min(1280px,96vw);height:min(820px,92vh);
  background:#f8f9fa;border:1px solid #d0d5dd;border-radius:6px;
  box-shadow:0 12px 28px rgba(16,24,40,.18),0 2px 6px rgba(16,24,40,.08);
  padding:12px;display:grid;place-items:center;
  cursor:pointer;transition:transform .3s ease
}
.frame:hover{transform:scale(1.01)}
.book{width:100%;height:100%}
.df-ui .df-controls{bottom:8px!important;top:auto!important}

/* üìò —Ç–µ–Ω–∏ –æ–±–ª–æ–∂–µ–∫ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –∫–æ—Ä–µ—à–∫–∞ */
.dflip .df-page.first .dfp-inner::before{
  content:"";position:absolute;inset:0 auto 0 0;width:24px;pointer-events:none;
  background:linear-gradient(90deg,
    rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
  mix-blend-mode:multiply;opacity:.75;border-radius:2px 0 0 2px;
}
.dflip .df-page.last .dfp-inner::after{
  content:"";position:absolute;inset:0 0 0 auto;width:24px;pointer-events:none;
  background:linear-gradient(270deg,
    rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
  mix-blend-mode:multiply;opacity:.75;border-radius:0 2px 2px 0;
}
/* üìñ –∂–µ–ª–æ–±–æ–∫ –Ω–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ */
.dflip .df-spread .df-page.left .dfp-inner::after{
  content:"";position:absolute;top:0;bottom:0;right:-1px;width:26px;pointer-events:none;
  background:radial-gradient(ellipse at right center,
    rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
  mix-blend-mode:multiply;opacity:.75;
}
.dflip .df-spread .df-page.right .dfp-inner::before{
  content:"";position:absolute;top:0;bottom:0;left:-1px;width:26px;pointer-events:none;
  background:radial-gradient(ellipse at left center,
    rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
  mix-blend-mode:multiply;opacity:.75;
}
.dflip .df-page .dfp-inner{box-shadow:inset 0 0 0.5px rgba(0,0,0,.08)}

/* ü©∂ –º–∏–Ω–∏-–±–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏ */
.version-badge{
  position:fixed;right:10px;bottom:8px;z-index:9999;
  background:rgba(33,37,41,.72);color:#f8f9fa;
  border-radius:6px;padding:3px 7px;font-size:11px;font-weight:500;
  letter-spacing:.3px;opacity:.85;user-select:none;
  transition:opacity .2s ease,transform .2s ease;
}
.version-badge:hover{opacity:1;transform:scale(1.04)}
</style>
</head>
<body>

<div class="frame" id="book-frame">
  <div id="book" class="_df_book book"
       source=""                      <!-- –∑–∞–¥–∞–¥–∏–º –ø—Ä–∏ open(...) -->
       backgroundcolor="#e9ecef"
       webgl="true" sound="true" autoPlay="false">
  </div>
</div>

<div class="version-badge">v2025-10-07.12</div>

<!-- –ø–æ—Ä—è–¥–æ–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤–∞–∂–µ–Ω -->
<script src="js/jquery.min.js"></script>
<script src="js/pdf.min.js"></script>
<script>
if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/libs/pdf.worker.min.js';
}
</script>
<script src="js/three.min.js"></script>
<script src="js/dflip.min.js"></script>

<!-- –≤—ã–±–æ—Ä PDF (–Ω–∞–¥—ë–∂–Ω—ã–π –¥–ª—è Telegram/–≤–µ–±–≤—å—é) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const ua = navigator.userAgent || '';
  const isTG = /Telegram/i.test(ua);
  const isMobileUA = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
  const isCoarse = window.matchMedia && matchMedia('(pointer: coarse)').matches;
  const narrowVW = matchMedia('(max-width: 820px)').matches
                || matchMedia('(max-device-width: 820px)').matches;

  const useMobile = isTG || isMobileUA || isCoarse || narrowVW;

  window.__PDF_FILE__ = useMobile
    ? 'emilia_and_the_pebbles_mobile.pdf'
    : 'emilia_and_the_pebbles.pdf';

  // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)
  const tag = document.createElement('div');
  tag.textContent = 'PDF: ' + (useMobile ? 'mobile' : 'desktop');
  tag.style.cssText =
    'position:fixed;left:10px;bottom:8px;z-index:9999;background:rgba(0,0,0,.55);'+
    'color:#fff;padding:4px 6px;border-radius:6px;font:11px/1 system-ui';
  document.body.appendChild(tag);
});
</script>

<script>
/* –æ–ø—Ü–∏–∏ –∫–Ω–∏–≥–∏ */
var option_book = {
  mockupType: "hard",
  hard: "cover",
  autoPlay: false,
  startPage: 0,
  pageMode: DFLIP.PAGE_MODE.AUTO,
  singlePageMode: DFLIP.SINGLE_PAGE_MODE.BOOKLET,
  controlsPosition: DFLIP.CONTROLSPOSITION.BOTTOM,
  showDownloadControl: true,
  showPrintControl: true,
  showSearchControl: true,
  showSoundControl: true,
  showFullscreenControl: true,
  showFitControl: true,
  duration: 800,
  autoEnableThumbnail: false,
  autoEnableOutline: false,
  backgroundColor: "#e9ecef"
};

/* –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É + –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π source */
const frame = document.getElementById('book-frame');
const bookEl = document.getElementById('book');

frame.addEventListener('click', function openOnce(){
  const src = window.__PDF_FILE__ || 'emilia_and_the_pebbles.pdf';
  DFLIP.open(bookEl, { source: src });   // ‚Üê –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –¥–∞—ë–º —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é

  // –¥–æ–∂–¥—ë–º—Å—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ü–µ–Ω—ã –∏ –¥–æ–±–∞–≤–∏–º 3D-–∫–æ—Ä–µ—à–æ–∫
  const wait = setInterval(()=>{
    const flip = DFLIP && DFLIP.BookInstance;
    if (!flip || !flip.scene || !window.THREE) return;
    clearInterval(wait);
    addSpine3D(flip);
  },120);

  frame.style.cursor = 'default';
  frame.removeEventListener('click', openOnce);
}, { once:true });

/* unlock –∞—É–¥–∏–æ (–±–µ–∑ –¥—É–±–ª–µ–π) */
document.addEventListener('DOMContentLoaded',()=>{
  const unlock=()=>{
    const t=new Audio('sound/turn2.mp3'); t.volume=0;
    t.play().then(()=>{ t.pause(); t.src=''; });
    document.removeEventListener('click',unlock);
    document.removeEventListener('keydown',unlock);
  };
  document.addEventListener('click',unlock,{once:true});
  document.addEventListener('keydown',unlock,{once:true});
});

/* 3D-–∫–æ—Ä–µ—à–æ–∫ –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –≥–∞–±–∞—Ä–∏—Ç–∞–º –∫–Ω–∏–≥–∏ */
function addSpine3D(flip){
  const scene = flip.scene;
  if (!scene || !window.THREE) return;

  // –Ω–∞–π–¥—ë–º –∫–æ—Ä–Ω–µ–≤—É—é –≥—Ä—É–ø–ø—É –∫–Ω–∏–≥–∏, –∏–Ω–∞—á–µ –≤–æ–∑—å–º—ë–º –≤—Å—é —Å—Ü–µ–Ω—É
  const root = scene.children.find(o =>
    /book|pages|wrapper|container/i.test(o.name || '')
  ) || scene;

  // —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –≥–∞–±–∞—Ä–∏—Ç—ã
  const box  = new THREE.Box3().setFromObject(root);
  const size = new THREE.Vector3(); box.getSize(size);
  const center = new THREE.Vector3(); box.getCenter(center);

  // —Ä–∞–∑–º–µ—Ä—ã/–ø–æ–∑–∏—Ü–∏—è –∫–æ—Ä–µ—à–∫–∞
  const H = size.y * 1.02;      // –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ –∫–Ω–∏–≥–∏
  const D = size.z * 1.02;      // –Ω–µ–º–Ω–æ–≥–æ –≥–ª—É–±–∂–µ
  const T = size.x * 0.035;     // —Ç–æ–ª—â–∏–Ω–∞ ~3.5% —à–∏—Ä–∏–Ω—ã (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
  const leftX = box.min.x;      // –ª–µ–≤—ã–π –∫—Ä–∞–π –∫–Ω–∏–≥–∏

  const spine = new THREE.Mesh(
    new THREE.BoxGeometry(T, H, D),
    new THREE.MeshStandardMaterial({ color: 0x2f2f2f, metalness: 0.35, roughness: 0.65 })
  );
  // –ø–æ—Å—Ç–∞–≤–∏–º —á—É—Ç—å —Å–Ω–∞—Ä—É–∂–∏, —á—Ç–æ–±—ã –Ω–µ ¬´—Å–ª–∏–ø—Å—è¬ª —Å –æ–±–ª–æ–∂–∫–æ–π
  spine.position.set(leftX - T/2 - (size.x * 0.002), center.y, center.z);
  spine.name = 'custom-spine';
  spine.castShadow = false; spine.receiveShadow = false; spine.renderOrder = 2;
  scene.add(spine);

  // –Ω–µ–±–æ–ª—å—à–æ–π —Å–≤–µ—Ç –¥–ª—è –±–ª–∏–∫–∞
  const light = new THREE.PointLight(0xffffff, 0.32);
  light.position.set(leftX - size.x*0.4, center.y + size.y*0.3, center.z + size.z);
  scene.add(light);

  console.log('[spine] added at X=', spine.position.x, {H,D,T});
}
</script>
</body>
</html>
