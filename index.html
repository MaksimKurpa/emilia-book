<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Эмилия и камушки в волосах — v2025-10-07.13</title>

<link rel="stylesheet" href="css/dflip.min.css" />

<style>
  body{margin:0;background:#e9ecef;min-height:100vh;display:grid;place-items:center;
       font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  .frame{width:min(1280px,96vw);height:min(820px,92vh);background:#f8f9fa;border:1px solid #d0d5dd;
         border-radius:6px;box-shadow:0 12px 28px rgba(16,24,40,.18),0 2px 6px rgba(16,24,40,.08);
         padding:12px;display:grid;place-items:center}
  .book{width:100%;height:100%}
  .df-ui .df-controls{bottom:8px!important;top:auto!important}
  /* тени обложек */
  .dflip .df-page.first .dfp-inner::before{
    content:"";position:absolute;inset:0 auto 0 0;width:24px;pointer-events:none;
    background:linear-gradient(90deg,rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
    mix-blend-mode:multiply;opacity:.75;border-radius:2px 0 0 2px;
  }
  .dflip .df-page.last .dfp-inner::after{
    content:"";position:absolute;inset:0 0 0 auto;width:24px;pointer-events:none;
    background:linear-gradient(270deg,rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
    mix-blend-mode:multiply;opacity:.75;border-radius:0 2px 2px 0;
  }
  /* желобок */
  .dflip .df-spread .df-page.left .dfp-inner::after{
    content:"";position:absolute;top:0;bottom:0;right:-1px;width:26px;pointer-events:none;
    background:radial-gradient(ellipse at right center,rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
    mix-blend-mode:multiply;opacity:.75;
  }
  .dflip .df-spread .df-page.right .dfp-inner::before{
    content:"";position:absolute;top:0;bottom:0;left:-1px;width:26px;pointer-events:none;
    background:radial-gradient(ellipse at left center,rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
    mix-blend-mode:multiply;opacity:.75;
  }
  .dflip .df-page .dfp-inner{box-shadow:inset 0 0 0.5px rgba(0,0,0,.08)}
  .version-badge{position:fixed;right:10px;bottom:8px;z-index:9999;background:rgba(33,37,41,.72);color:#f8f9fa;
    border-radius:6px;padding:3px 7px;font-size:11px;font-weight:500;letter-spacing:.3px;opacity:.85}
</style>
</head>
<body>

<div class="frame">
  <!-- ВАЖНО: тут пока НЕТ класса _df_book, добавим его после выбора source -->
  <div id="flip" class="book" backgroundcolor="#e9ecef" webgl="true" sound="true"></div>
</div>

<div class="version-badge">v2025-10-07.13</div>

<!-- порядок скриптов -->
<script src="js/jquery.min.js"></script>
<script src="js/pdf.min.js"></script>
<script> if (window.pdfjsLib){ pdfjsLib.GlobalWorkerOptions.workerSrc='js/libs/pdf.worker.min.js'; } </script>
<script src="js/three.min.js"></script>
<script src="js/dflip.min.js"></script>

<script>
/* 1) глобальные дефолты — удобно вешать onReady сюда (официально так и делают) */
jQuery(function(){
  DFLIP.defaults = DFLIP.defaults || {};
  DFLIP.defaults.onReady = function(flipbook){
    // добавим 3D «корешок» когда сцена готова
    addSpine3D(flipbook);
  };
});
</script>

<script>
/* 2) выбор PDF и инициализация по документации: option_<ID>.source + addClass('_df_book') */
document.addEventListener('DOMContentLoaded', function () {
  const ua = navigator.userAgent || '';
  const isTG = /Telegram/i.test(ua);
  const isMobileUA = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
  const isCoarse = window.matchMedia && matchMedia('(pointer: coarse)').matches;
  const narrow = matchMedia('(max-width: 820px)').matches || matchMedia('(max-device-width: 820px)').matches;

  const useMobile = isTG || isMobileUA || isCoarse || narrow;

  // КЛЮЧ: имя переменной ДОЛЖНО быть option_<id>
  window.option_flip = {
    source: useMobile ? 'emilia_and_the_pebbles_mobile.pdf' : 'emilia_and_the_pebbles.pdf',
    mockupType: "hard",
    hard: "cover",
    autoPlay: false,
    startPage: 0,
    pageMode: DFLIP.PAGE_MODE.AUTO,
    singlePageMode: useMobile ? DFLIP.SINGLE_PAGE_MODE.SINGLE : DFLIP.SINGLE_PAGE_MODE.BOOKLET,
    controlsPosition: DFLIP.CONTROLSPOSITION.BOTTOM,
    showDownloadControl: true,
    showPrintControl: !useMobile,
    showSearchControl: true,
    showSoundControl: true,
    showFullscreenControl: true,
    showFitControl: true,
    duration: 800,
    autoEnableThumbnail: false,
    autoEnableOutline: false,
    backgroundColor: "#e9ecef"
  };

  // Инициализируем плагин ровно после того, как задали source:
  jQuery('#flip').addClass('_df_book'); // ← так советуют в их примере «auto open with URL»
});
</script>

<script>
/* 3) звук-unlock (без дублей) */
document.addEventListener('DOMContentLoaded',()=>{
  const unlock=()=>{
    const t=new Audio('sound/turn2.mp3'); t.volume=0;
    t.play().then(()=>{ t.pause(); t.src=''; });
    document.removeEventListener('click',unlock);
    document.removeEventListener('keydown',unlock);
  };
  document.addEventListener('click',unlock,{once:true});
  document.addEventListener('keydown',unlock,{once:true});
});

/* 4) 3D корешок по реальным габаритам */
function addSpine3D(app){
  const scene = app && app.scene;
  if (!scene || !window.THREE) return;

  const root = scene.children.find(o => /book|pages|wrapper|container/i.test(o.name||'')) || scene;
  const box  = new THREE.Box3().setFromObject(root);
  const size = new THREE.Vector3(); box.getSize(size);
  const center = new THREE.Vector3(); box.getCenter(center);

  const H = size.y * 1.02, D = size.z * 1.02, T = size.x * 0.035;
  const leftX = box.min.x;

  const spine = new THREE.Mesh(
    new THREE.BoxGeometry(T,H,D),
    new THREE.MeshStandardMaterial({ color: 0x2f2f2f, metalness: 0.35, roughness: 0.65 })
  );
  spine.position.set(leftX - T/2 - (size.x*0.002), center.y, center.z);
  spine.name = 'custom-spine';
  scene.add(spine);

  const light = new THREE.PointLight(0xffffff, 0.32);
  light.position.set(leftX - size.x*0.4, center.y + size.y*0.3, center.z + size.z);
  scene.add(light);

  console.log('[spine] added', {T,H,D,x:spine.position.x});
}
</script>

</body>
</html>
