<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–≠–º–∏–ª–∏—è –∏ –∫–∞–º—É—à–∫–∏ –≤ –≤–æ–ª–æ—Å–∞—Ö ‚Äî v2025-10-07.6</title>

  <!-- DFlip CSS -->
  <link rel="stylesheet" href="css/dflip.min.css" />

  <style>
    body{
      margin:0;background:#e9ecef;min-height:100vh;
      display:grid;place-items:center;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif
    }
    .frame{
      width:min(1280px,96vw);height:min(820px,92vh);
      background:#f8f9fa;border:1px solid #d0d5dd;border-radius:6px;
      box-shadow:0 12px 28px rgba(16,24,40,.18),0 2px 6px rgba(16,24,40,.08);
      padding:12px;display:grid;place-items:center;
      cursor:pointer;transition:transform .3s ease
    }
    .frame:hover{transform:scale(1.01)}
    .book{width:100%;height:100%}

    /* —Ç—É–ª–±–∞—Ä —Å–Ω–∏–∑—É */
    .df-ui .df-controls{bottom:8px!important;top:auto!important}

    /* üìò —Ç–µ–Ω–∏ ¬´—Å–≥–∏–±–∞¬ª ‚Äî –ø–µ—Ä–µ–¥–Ω—è—è/–∑–∞–¥–Ω—è—è –æ–±–ª–æ–∂–∫–∏ */
    .dflip .df-page.first .dfp-inner::before{
      content:"";position:absolute;inset:0 auto 0 0;width:24px;pointer-events:none;
      background:linear-gradient(90deg,
        rgba(0,0,0,.45) 0%,
        rgba(0,0,0,.25) 25%,
        rgba(255,255,255,.15) 60%,
        rgba(255,255,255,0) 100%);
      mix-blend-mode:multiply;opacity:.75;border-radius:2px 0 0 2px;
    }
    .dflip .df-page.last .dfp-inner::after{
      content:"";position:absolute;inset:0 0 0 auto;width:24px;pointer-events:none;
      background:linear-gradient(270deg,
        rgba(0,0,0,.45) 0%,
        rgba(0,0,0,.25) 25%,
        rgba(255,255,255,.15) 60%,
        rgba(255,255,255,0) 100%);
      mix-blend-mode:multiply;opacity:.75;border-radius:0 2px 2px 0;
    }

    /* üìñ –∂–µ–ª–æ–±–æ–∫ –Ω–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ */
    .dflip .df-spread .df-page.left .dfp-inner::after{
      content:"";position:absolute;top:0;bottom:0;right:-1px;width:26px;pointer-events:none;
      background:radial-gradient(ellipse at right center,
        rgba(0,0,0,.28) 0%, rgba(0,0,0,.12) 45%, rgba(0,0,0,0) 70%);
      mix-blend-mode:multiply;opacity:.75;
    }
    .dflip .df-spread .df-page.right .dfp-inner::before{
      content:"";position:absolute;top:0;bottom:0;left:-1px;width:26px;pointer-events:none;
      background:radial-gradient(ellipse at left center,
        rgba(0,0,0,.28) 0%, rgba(0,0,0,.12) 45%, rgba(0,0,0,0) 70%);
      mix-blend-mode:multiply;opacity:.75;
    }
    .dflip .df-page .dfp-inner{box-shadow:inset 0 0 0.5px rgba(0,0,0,.08)}

    /* ü©∂ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏ */
    .version-badge{
      position:fixed;right:10px;bottom:8px;z-index:9999;
      background:rgba(33,37,41,.72);color:#f8f9fa;
      border-radius:6px;padding:3px 7px;
      font-size:11px;font-weight:500;letter-spacing:.3px;
      opacity:.85;user-select:none;transition:opacity .2s ease,transform .2s ease;
    }
    .version-badge:hover{opacity:1;transform:scale(1.04)}
  </style>
</head>
<body>

  <div class="frame" id="book-frame">
    <div id="book" class="_df_book book"
         source=""                       <!-- –∑–∞–ø–æ–ª–Ω–∏–º —á–µ—Ä–µ–∑ JS (blob:) -->
         backgroundcolor="#e9ecef"
         webgl="true" sound="true" autoPlay="false">
    </div>
  </div>

  <div class="version-badge">v2025-10-07.6</div>

  <!-- –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∂–µ–Ω -->
  <script src="js/jquery.min.js"></script>

  <!-- PDF.js + worker (3.11.174) -->
  <script src="js/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/libs/pdf.worker.min.js';
    }
  </script>

  <!-- Three.js -->
  <script src="js/three.min.js"></script>

  <!-- DFlip -->
  <script src="js/dflip.min.js"></script>

  <script>
    // ==== –æ–ø—Ü–∏–∏ –∫–Ω–∏–≥–∏ ====
    var option_book = {
      mockupType: "hard",     // "hard" | "spiral" | "magazine"
      hard: "cover",
      autoPlay: false,
      startPage: 0,
      pageMode: DFLIP.PAGE_MODE.AUTO,
      singlePageMode: DFLIP.SINGLE_PAGE_MODE.BOOKLET,
      controlsPosition: DFLIP.CONTROLSPOSITION.BOTTOM,
      showDownloadControl: true,
      showPrintControl: true,
      showSearchControl: true,
      showSoundControl: true,
      showFullscreenControl: true,
      showFitControl: true,
      duration: 800,
      autoEnableThumbnail: false,
      autoEnableOutline: false,
      backgroundColor: "#e9ecef"
    };

    // ==== –≤—ã–±–æ—Ä PDF: desktop / mobile + —Ä—É—á–Ω–æ–π override ?pdf=mobile|desktop ====
    const PDFs = {
      desktop: 'emilia_and_the_pebbles.pdf',
      mobile:  'emilia_and_the_pebbles_mobile.pdf'
    };
    const urlParams = new URLSearchParams(location.search);
    const override = urlParams.get('pdf'); // 'mobile' | 'desktop' | null
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
                     || Math.min(window.innerWidth, window.innerHeight) <= 820;
    const chosenKey = (override === 'mobile' || override === 'desktop')
        ? override : (isMobile ? 'mobile' : 'desktop');

    // –ù–∞ –º–æ–±–∏–ª–∫–µ —É–¥–æ–±–Ω–µ–µ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–º–µ–Ω—å—à–µ –∫–Ω–æ–ø–æ–∫
    if (chosenKey === 'mobile') {
      option_book.singlePageMode = DFLIP.SINGLE_PAGE_MODE.SINGLE;
      option_book.pageMode       = DFLIP.PAGE_MODE.SINGLE;
      option_book.showPrintControl = false;
    }

    // ==== –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º PDF –∫–∞–∫ blob:URL (—É—Å—Ç–æ–π—á–∏–≤–æ –∫ –∫—ç—à—É/CORS) ====
    async function setPdfSource(pdfPath) {
      try {
        const resp = await fetch(pdfPath, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const blobUrl = URL.createObjectURL(await resp.blob());
        document.getElementById('book').setAttribute('source', blobUrl);
        console.log('PDF:', pdfPath, '‚Üí', blobUrl);
      } catch (e) {
        console.error('PDF fetch failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PDF: ' + pdfPath);
      }
    }

    // ==== –æ—Ç–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É (–∫–∞–∫ –≤ –¥–µ–º–æ) ====
    const frame = document.getElementById('book-frame');
    const bookEl = document.getElementById('book');
    frame.addEventListener('click', function openOnce(){
      DFLIP.open(bookEl);

      // –∂–¥—ë–º, –ø–æ–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å—Ü–µ–Ω–∞, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–∏–º 3D-–∫–æ—Ä–µ—à–æ–∫
      const wait = setInterval(() => {
        const flip = DFLIP && DFLIP.BookInstance;
        if (!flip || !flip.scene || !window.THREE) return;
        clearInterval(wait);
        addSpine3D(flip);
      }, 120);
      frame.style.cursor = 'default';
      frame.removeEventListener('click', openOnce);
    }, { once:true });

    // ==== unlock –∑–≤—É–∫–∞ (–±–µ–∑ –¥—É–±–ª—è–∂–∞) ====
    document.addEventListener('DOMContentLoaded', () => {
      const unlock = () => {
        const test = new Audio('sound/turn2.mp3');
        test.volume = 0;
        test.play().then(()=>{ test.pause(); test.src=''; });
        document.removeEventListener('click', unlock);
        document.removeEventListener('keydown', unlock);
      };
      document.addEventListener('click', unlock, { once:true });
      document.addEventListener('keydown', unlock, { once:true });
    });

    // ==== 3D-¬´–∫–æ—Ä–µ—à–æ–∫¬ª –≤ —Å—Ü–µ–Ω–µ ====
    function addSpine3D(flip){
      const scene = flip.scene;
      const H = (flip.view && (flip.view._h || flip.view.h)) || 1.05; // –≤—ã—Å–æ—Ç–∞
      const D = (flip.view && (flip.view._w || flip.view.w)) || 0.82; // –≥–ª—É–±–∏–Ω–∞
      const T = 0.045;                                                // —Ç–æ–ª—â–∏–Ω–∞ –∫–æ—Ä–µ—à–∫–∞

      const spine = new THREE.Mesh(
        new THREE.BoxGeometry(T, H, D),
        new THREE.MeshStandardMaterial({ color: 0x2f2f2f, metalness: 0.35, roughness: 0.65 })
      );
      spine.position.set(-0.52, 0, 0);   // –ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ –≤–∫—É—Å—É: -0.55...-0.48
      spine.name = 'custom-spine';
      scene.add(spine);

      const light = new THREE.PointLight(0xffffff, 0.28);
      light.position.set(-0.9, 0.6, 1.1);
      scene.add(light);

      console.log('[spine] added', {H,D,T});
    }

    // ==== –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ PDF ====
    setPdfSource(PDFs[chosenKey]);
  </script>
</body>
</html>
