<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–≠–º–∏–ª–∏—è –∏ –∫–∞–º—É—à–∫–∏ –≤ –≤–æ–ª–æ—Å–∞—Ö ‚Äî v2025-10-07.8</title>

<link rel="stylesheet" href="css/dflip.min.css" />

<style>
body{
  margin:0;background:#e9ecef;min-height:100vh;
  display:grid;place-items:center;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif
}
.frame{
  width:min(1280px,96vw);height:min(820px,92vh);
  background:#f8f9fa;border:1px solid #d0d5dd;border-radius:6px;
  box-shadow:0 12px 28px rgba(16,24,40,.18),0 2px 6px rgba(16,24,40,.08);
  padding:12px;display:grid;place-items:center;
  cursor:pointer;transition:transform .3s ease
}
.frame:hover{transform:scale(1.01)}
.book{width:100%;height:100%}
.df-ui .df-controls{bottom:8px!important;top:auto!important}

/* üìò —Ç–µ–Ω–∏ –æ–±–ª–æ–∂–µ–∫ */
.dflip .df-page.first .dfp-inner::before{
  content:"";position:absolute;inset:0 auto 0 0;width:24px;pointer-events:none;
  background:linear-gradient(90deg,
    rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
  mix-blend-mode:multiply;opacity:.75;border-radius:2px 0 0 2px;
}
.dflip .df-page.last .dfp-inner::after{
  content:"";position:absolute;inset:0 0 0 auto;width:24px;pointer-events:none;
  background:linear-gradient(270deg,
    rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 25%,rgba(255,255,255,.15) 60%,rgba(255,255,255,0) 100%);
  mix-blend-mode:multiply;opacity:.75;border-radius:0 2px 2px 0;
}
/* üìñ –∂–µ–ª–æ–±–æ–∫ */
.dflip .df-spread .df-page.left .dfp-inner::after{
  content:"";position:absolute;top:0;bottom:0;right:-1px;width:26px;pointer-events:none;
  background:radial-gradient(ellipse at right center,
    rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
  mix-blend-mode:multiply;opacity:.75;
}
.dflip .df-spread .df-page.right .dfp-inner::before{
  content:"";position:absolute;top:0;bottom:0;left:-1px;width:26px;pointer-events:none;
  background:radial-gradient(ellipse at left center,
    rgba(0,0,0,.28) 0%,rgba(0,0,0,.12) 45%,rgba(0,0,0,0) 70%);
  mix-blend-mode:multiply;opacity:.75;
}
.dflip .df-page .dfp-inner{box-shadow:inset 0 0 0.5px rgba(0,0,0,.08)}

/* ü©∂ –±–µ–π–¥–∂ */
.version-badge{
  position:fixed;right:10px;bottom:8px;z-index:9999;
  background:rgba(33,37,41,.72);color:#f8f9fa;
  border-radius:6px;padding:3px 7px;font-size:11px;font-weight:500;
  letter-spacing:.3px;opacity:.85;user-select:none;
  transition:opacity .2s ease,transform .2s ease;
}
.version-badge:hover{opacity:1;transform:scale(1.04)}
</style>
</head>
<body>

<div class="frame" id="book-frame">
  <div id="book" class="_df_book book"
       source=""
       backgroundcolor="#e9ecef"
       webgl="true" sound="true" autoPlay="false">
  </div>
</div>

<div class="version-badge">v2025-10-07.8</div>

<script src="js/jquery.min.js"></script>
<script src="js/pdf.min.js"></script>
<script>
if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/libs/pdf.worker.min.js';
}
</script>
<script src="js/three.min.js"></script>
<script src="js/dflip.min.js"></script>

<script>
/* === –æ–ø—Ü–∏–∏ –∫–Ω–∏–≥–∏ === */
var option_book = {
  mockupType: "hard",
  hard: "cover",
  autoPlay: false,
  startPage: 0,
  pageMode: DFLIP.PAGE_MODE.AUTO,
  singlePageMode: DFLIP.SINGLE_PAGE_MODE.BOOKLET,
  controlsPosition: DFLIP.CONTROLSPOSITION.BOTTOM,
  showDownloadControl: true,
  showPrintControl: true,
  showSearchControl: true,
  showSoundControl: true,
  showFullscreenControl: true,
  showFitControl: true,
  duration: 800,
  autoEnableThumbnail: false,
  autoEnableOutline: false,
  backgroundColor: "#e9ecef"
};

/* === –≤—ã–±–æ—Ä PDF: desktop / mobile === */
const PDFs = {
  desktop: ['emilia_and_the_pebbles.pdf'],
  mobile:  ['emilia_and_the_pebbles_mobile.pdf']
};
const params = new URLSearchParams(location.search);
const override = params.get('pdf'); // mobile|desktop
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
                 || Math.min(window.innerWidth, window.innerHeight) <= 820;
const preferred = (override === 'mobile' || override === 'desktop')
    ? override : (isMobile ? 'mobile' : 'desktop');

/* –º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
if (preferred === 'mobile') {
  option_book.singlePageMode = DFLIP.SINGLE_PAGE_MODE.SINGLE;
  option_book.pageMode = DFLIP.PAGE_MODE.SINGLE;
  option_book.showPrintControl = false;
}

/* === –∑–∞–≥—Ä—É–∑–∫–∞ PDF === */
async function fetchPdf(pathList) {
  for (const p of pathList) {
    try {
      const r = await fetch(p, { cache:'no-store' });
      if (r.ok) {
        const blobUrl = URL.createObjectURL(await r.blob());
        console.log('[PDF loaded]', p);
        return { blobUrl, path: p };
      }
    } catch (e) { console.warn('[fetch fail]', p, e); }
  }
  throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –æ–¥–∏–Ω PDF: ' + pathList.join(', '));
}

async function setPdfSource() {
  try {
    const primary = await fetchPdf(PDFs[preferred]);
    document.getElementById('book').setAttribute('source', primary.blobUrl);
    console.log('Chosen PDF:', preferred, primary.path);
  } catch (err) {
    console.warn('[Primary failed]', err);
    const fbKey = preferred === 'mobile' ? 'desktop' : 'mobile';
    try {
      const fb = await fetchPdf(PDFs[fbKey]);
      document.getElementById('book').setAttribute('source', fb.blobUrl);
      console.log('Fallback PDF:', fbKey, fb.path);
    } catch (e2) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–∏–Ω PDF');
    }
  }
}

/* === –æ—Ç–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É –∏ –¥–æ–±–∞–≤–∏—Ç—å 3D-–∫–æ—Ä–µ—à–æ–∫ === */
const frame=document.getElementById('book-frame');
const bookEl=document.getElementById('book');
frame.addEventListener('click',function openOnce(){
  DFLIP.open(bookEl);
  const wait=setInterval(()=>{
    const flip=DFLIP&&DFLIP.BookInstance;
    if(!flip||!flip.scene||!window.THREE)return;
    clearInterval(wait);
    addSpine3D(flip);
  },120);
  frame.style.cursor='default';
  frame.removeEventListener('click',openOnce);
},{once:true});

/* === unlock –∞—É–¥–∏–æ === */
document.addEventListener('DOMContentLoaded',()=>{
  const unlock=()=>{
    const t=new Audio('sound/turn2.mp3');t.volume=0;
    t.play().then(()=>{t.pause();t.src='';});
    document.removeEventListener('click',unlock);
    document.removeEventListener('keydown',unlock);
  };
  document.addEventListener('click',unlock,{once:true});
  document.addEventListener('keydown',unlock,{once:true});
});

/* === 3D-–∫–æ—Ä–µ—à–æ–∫ === */
function addSpine3D(flip){
  const scene=flip.scene;
  const H=(flip.view&&(flip.view._h||flip.view.h))||1.05;
  const D=(flip.view&&(flip.view._w||flip.view.w))||0.82;
  const T=0.045;
  const spine=new THREE.Mesh(
    new THREE.BoxGeometry(T,H,D),
    new THREE.MeshStandardMaterial({color:0x2f2f2f,metalness:0.35,roughness:0.65})
  );
  spine.position.set(-0.52,0,0);
  scene.add(spine);
  const light=new THREE.PointLight(0xffffff,0.28);
  light.position.set(-0.9,0.6,1.1);
  scene.add(light);
  console.log('[spine added]');
}

/* === –∑–∞–ø—É—Å–∫ === */
setPdfSource();
</script>
</body>
</html>
